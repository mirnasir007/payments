<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Admin Panel</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .btn-loader { border: 3px solid transparent; border-top: 3px solid #ffffff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-item.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
        .modal-exit { opacity: 0; transform: scale(0.95); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="text-center mb-6">
                <span class="material-icons text-blue-600 text-5xl">admin_panel_settings</span>
                <h2 class="text-2xl font-bold text-gray-800 mt-2">Admin Login</h2>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-password" class="mt-1 w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Invalid Password</div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">Login</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <input type="hidden" id="script-url" value="https://script.google.com/macros/s/AKfycbyYeax3bAlEeHc3DwZP0zcD9zmD42s5qcPfs2QQHalkh1WDdHayUy7e3QkVTlAfB0Wk/exec">
        
        <nav class="bg-white shadow-sm border-b px-4 md:px-8 flex justify-between items-center h-16 sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <span class="material-icons text-blue-600">admin_panel_settings</span>
                <span class="font-bold text-lg text-gray-800">License Admin</span>
            </div>
            <div class="flex gap-6 h-full items-center">
                <button onclick="switchTab('pending-page')" class="nav-item active h-full px-2 text-gray-600 hover:text-blue-600 transition" id="tab-pending">Pending Approvals</button>
                <button onclick="switchTab('clients-page')" class="nav-item h-full px-2 text-gray-600 hover:text-blue-600 transition" id="tab-clients">Manage Clients</button>
            </div>
            <button onclick="logout()" class="text-gray-500 hover:text-red-600 transition flex items-center gap-1 text-sm font-bold">
                <span class="material-icons text-sm">logout</span> Logout
            </button>
        </nav>

        <div class="max-w-6xl mx-auto p-4 md:p-8">
            <div id="status-msg" class="hidden mb-4 p-4 rounded-lg text-center font-medium shadow-sm"></div>

            <div id="pending-page" class="page active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">Pending Requests</h2>
                    <button onclick="fetchPending()" class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 border rounded-lg font-semibold flex items-center gap-2 shadow-sm">
                        <span class="material-icons text-sm">refresh</span> Refresh
                    </button>
                </div>
                <div id="pending-container" class="space-y-4"></div>
            </div>

            <div id="clients-page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-700">Client List</h2>
                    <div class="flex gap-2">
                        <button onclick="fetchClients()" class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 border rounded-lg font-semibold flex items-center gap-2 shadow-sm">
                            <span class="material-icons text-sm">refresh</span>
                        </button>
                        <button onclick="openModal('add-client-modal', 'add-panel')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 shadow-sm">
                            <span class="material-icons text-sm">add</span> Add Client
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Sheet ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Expiry Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Package Price</th>
                                    <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform scale-95 transition-all duration-300 opacity-0" id="approve-panel">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Confirm Approval</h3>
            <p class="text-sm text-gray-500 mb-6">Are you sure? This will accept payment and add <span class="font-bold text-blue-600 bg-blue-50 px-1 rounded">30 DAYS</span> validity to this user's license.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('confirm-modal', 'approve-panel')" class="px-4 py-2 border rounded-lg text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                <button id="approve-btn" onclick="executeApproval()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Yes, Approve</button>
            </div>
        </div>
    </div>

    <div id="add-client-modal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform scale-95 transition-all duration-300 opacity-0" id="add-panel">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Add New Client</h3>
            <form id="add-client-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Client Name</label><input type="text" id="add-name" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Sheet ID</label><input type="text" id="add-sheetid" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Package Price</label><input type="number" id="add-price" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Expiry Date</label><input type="date" id="add-expiry" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Status</label><select id="add-status" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="Active">Active</option><option value="Expired">Expired</option><option value="Pending">Pending</option></select></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('add-client-modal', 'add-panel')" class="px-4 py-2 border rounded-lg text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save Client</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-client-modal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform scale-95 transition-all duration-300 opacity-0" id="edit-panel">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Edit Client <span id="edit-client-name" class="text-blue-600"></span></h3>
            <form id="edit-client-form" class="space-y-4">
                <input type="hidden" id="edit-row">
                <div><label class="block text-sm font-medium text-gray-700">Package Price</label><input type="number" id="edit-price" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Expiry Date</label><input type="date" id="edit-expiry" required class="mt-1 w-full border rounded-lg px-3 py-2"></div>
                <div><label class="block text-sm font-medium text-gray-700">Status</label><select id="edit-status" class="mt-1 w-full border rounded-lg px-3 py-2"><option value="Active">Active</option><option value="Expired">Expired</option><option value="Pending">Pending</option></select></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('edit-client-modal', 'edit-panel')" class="px-4 py-2 border rounded-lg text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Update Client</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-client-modal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform scale-95 transition-all duration-300 opacity-0" id="delete-panel">
            <h3 class="text-lg font-bold text-red-600 mb-2">Delete Client</h3>
            <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete <span id="delete-client-name" class="font-bold text-gray-900"></span>? This action cannot be undone and will remove them from the sheet.</p>
            <input type="hidden" id="delete-row">
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('delete-client-modal', 'delete-panel')" class="px-4 py-2 border rounded-lg text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                <button id="confirm-delete-btn" onclick="executeDeleteClient()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Yes, Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = document.getElementById('script-url').value;
        let pendingSheetId = null;
        let pendingBtn = null;
        let ALL_CLIENTS = [];

        window.onload = () => {
            if (sessionStorage.getItem('adminAuth') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                fetchPending();
            }
        };

        // --- AUTH & NAVIGATION ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const origTxt = btn.innerText;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
            
            try {
                const res = await callAPI('adminLogin', { password: document.getElementById('admin-password').value });
                if (res.success) {
                    sessionStorage.setItem('adminAuth', 'true');
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    fetchPending();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch(err) { alert('Connection failed'); }
            finally { btn.innerText = origTxt; btn.disabled = false; }
        });

        function logout() {
            sessionStorage.removeItem('adminAuth');
            window.location.reload();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'pending-page') { document.getElementById('tab-pending').classList.add('active'); fetchPending(); }
            if(tabId === 'clients-page') { document.getElementById('tab-clients').classList.add('active'); fetchClients(); }
        }

        // --- PENDING REQUESTS ---
        async function fetchPending() {
            const container = document.getElementById('pending-container');
            container.innerHTML = `<div class="text-center py-12"><div class="loader mx-auto mb-3" style="width: 30px; height: 30px; border-width: 4px;"></div><p class="text-gray-500 font-medium">Checking requests...</p></div>`;
            try {
                const res = await callAPI('adminGetPending');
                if (res.success) {
                    if (res.pending.length === 0) {
                        container.innerHTML = `<div class="text-center py-12 bg-white rounded-xl shadow-sm border"><span class="material-icons text-green-500 text-5xl mb-2">check_circle_outline</span><h3 class="text-lg font-bold">No Pending Requests</h3></div>`;
                        return;
                    }
                    container.innerHTML = res.pending.map(item => `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${item.username} <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full font-bold ml-2">PENDING</span></h3>
                                    <div class="text-sm text-gray-600 mt-2 space-y-1">
                                        <p>TrxID: <span class="font-mono text-blue-600 font-bold">${item.trxId}</span></p>
                                        <p>Amount: <span class="font-bold text-green-600">${item.amount} Tk</span></p>
                                        <p class="text-xs text-gray-400 mt-1">Sheet ID: ${item.sheetId}</p>
                                    </div>
                                </div>
                                <button onclick="openApproveModal('${item.sheetId}', this)" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow flex items-center gap-2">
                                    <span class="material-icons text-sm">verified</span> Approve
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { container.innerHTML = `<div class="text-red-500 text-center py-8">Network Error</div>`; }
        }

        // --- CLIENT MANAGEMENT ---
        async function fetchClients() {
            const tbody = document.getElementById('clients-table-body');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12"><div class="loader mx-auto" style="border-width: 3px;"></div></td></tr>`;
            try {
                const res = await callAPI('adminGetAllClients');
                if (res.success) {
                    ALL_CLIENTS = res.clients;
                    tbody.innerHTML = res.clients.map((c, i) => {
                        let statusColor = c.status === 'Active' ? 'text-green-600 bg-green-50' : (c.status === 'Expired' ? 'text-red-600 bg-red-50' : 'text-yellow-600 bg-yellow-50');
                        
                        let isoDate = c.expiryDate;
                        if(isoDate && isoDate.includes('/')){
                            let parts = isoDate.split('/');
                            if(parts.length === 3) {
                                if(parts[0].length === 4) isoDate = `${parts[0]}-${parts[1]}-${parts[2]}`;
                                else isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }

                        return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900">${c.username}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${c.sheetId.substring(0,10)}...</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs font-bold rounded-full border ${statusColor}">${c.status}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.expiryDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${c.packagePrice || '0'} Tk</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center flex justify-center gap-2">
                                <button onclick="openEditModal(${i}, '${isoDate}', '${c.status}', '${c.packagePrice || 0}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 px-3 py-1 rounded-md font-semibold transition">Edit</button>
                                <button onclick="openDeleteModal(${i})" class="text-red-600 hover:text-red-900 bg-red-50 px-3 py-1 rounded-md font-semibold transition">Delete</button>
                            </td>
                        </tr>
                    `}).join('');
                }
            } catch (e) { tbody.innerHTML = `<tr><td colspan="5" class="text-red-500 text-center py-8">Error loading data</td></tr>`; }
        }

        document.getElementById('add-client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const origTxt = btn.innerText;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
            
            const payload = {
                username: document.getElementById('add-name').value,
                sheetId: document.getElementById('add-sheetid').value,
                packagePrice: document.getElementById('add-price').value,
                expiryDate: document.getElementById('add-expiry').value,
                status: document.getElementById('add-status').value
            };

            try {
                const res = await callAPI('adminAddClient', payload);
                if(res.success){
                    showStatus(res.message, 'success');
                    closeModal('add-client-modal', 'add-panel');
                    e.target.reset();
                    fetchClients();
                } else { alert(res.message); }
            } catch(err){} finally { btn.innerText = origTxt; btn.disabled = false; }
        });

        document.getElementById('edit-client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const origTxt = btn.innerText;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;
            
            const payload = {
                rowIdx: document.getElementById('edit-row').value,
                packagePrice: document.getElementById('edit-price').value,
                expiryDate: document.getElementById('edit-expiry').value,
                status: document.getElementById('edit-status').value
            };

            try {
                const res = await callAPI('adminUpdateClient', payload);
                if(res.success){
                    showStatus(res.message, 'success');
                    closeModal('edit-client-modal', 'edit-panel');
                    fetchClients();
                } else { alert(res.message); }
            } catch(err){} finally { btn.innerText = origTxt; btn.disabled = false; }
        });

        // --- UTILS & MODALS ---
        async function callAPI(action, payload = {}) {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, payload }) });
            return res.json();
        }

        function openApproveModal(sheetId, btn) {
            pendingSheetId = sheetId; pendingBtn = btn;
            openModal('confirm-modal', 'approve-panel');
        }

        async function executeApproval() {
            closeModal('confirm-modal', 'approve-panel');
            if(!pendingBtn) return;
            const btn = pendingBtn; const orig = btn.innerHTML;
            btn.innerHTML = `<div class="btn-loader"></div>`; btn.disabled = true;
            try {
                const res = await callAPI('adminApprove', { sheetId: pendingSheetId });
                if(res.success) {
                    showStatus('Approved Successfully', 'success');
                    fetchPending();
                } else { alert(res.message); btn.innerHTML = orig; btn.disabled = false; }
            } catch(e) { btn.innerHTML = orig; btn.disabled = false; }
        }

        function openEditModal(index, dateStr, status, price) {
            const client = ALL_CLIENTS[index];
            document.getElementById('edit-client-name').innerText = client.username;
            document.getElementById('edit-row').value = client.rowIdx;
            
            let formattedDate = dateStr;
            if(dateStr && dateStr.includes('/')){
                let parts = dateStr.split('/');
                if(parts.length === 3 && parts[2].length === 4) formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                else if(parts.length === 3 && parts[0].length === 4) formattedDate = `${parts[0]}-${parts[1]}-${parts[2]}`;
            }
            document.getElementById('edit-expiry').value = formattedDate;
            document.getElementById('edit-status').value = status;
            document.getElementById('edit-price').value = price;
            openModal('edit-client-modal', 'edit-panel');
        }

        function openDeleteModal(index) {
            const client = ALL_CLIENTS[index];
            document.getElementById('delete-client-name').innerText = client.username;
            document.getElementById('delete-row').value = client.rowIdx;
            openModal('delete-client-modal', 'delete-panel');
        }

        async function executeDeleteClient() {
            const btn = document.getElementById('confirm-delete-btn');
            const origTxt = btn.innerText;
            btn.innerHTML = '<div class="btn-loader"></div>'; btn.disabled = true;

            const rowIdx = document.getElementById('delete-row').value;

            try {
                const res = await callAPI('adminDeleteClient', { rowIdx: rowIdx });
                if(res.success){
                    showStatus(res.message, 'success');
                    closeModal('delete-client-modal', 'delete-panel');
                    fetchClients();
                } else { alert(res.message); }
            } catch(err) { alert('Failed to delete'); }
            finally { btn.innerText = origTxt; btn.disabled = false; }
        }

        function openModal(modalId, panelId = null) {
            const m = document.getElementById(modalId);
            m.classList.remove('hidden');
            if(panelId) {
                setTimeout(() => {
                    document.getElementById(panelId).classList.remove('scale-95', 'opacity-0');
                    document.getElementById(panelId).classList.add('scale-100', 'opacity-100');
                }, 10);
            }
        }

        function closeModal(modalId, panelId = null) {
            if(panelId) {
                document.getElementById(panelId).classList.remove('scale-100', 'opacity-100');
                document.getElementById(panelId).classList.add('scale-95', 'opacity-0');
            }
            setTimeout(() => document.getElementById(modalId).classList.add('hidden'), 200);
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-msg');
            el.className = `mb-4 p-4 rounded-lg text-center font-bold ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            el.innerText = msg; el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>
