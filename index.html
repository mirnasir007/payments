<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS payments</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
        .modal-exit { opacity: 0; transform: scale(0.95); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 flex justify-between items-center border border-gray-200">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-icons text-blue-600">admin_panel_settings</span>
                    POS Admin
                </h1>
                <p class="text-sm text-gray-500 mt-1">Manage licenses & payments</p>
            </div>
            <button onclick="fetchPending()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition">
                <span class="material-icons text-sm">refresh</span> Refresh
            </button>
        </div>

        <input type="hidden" id="script-url" value="https://script.google.com/macros/s/AKfycbyYeax3bAlEeHc3DwZP0zcD9zmD42s5qcPfs2QQHalkh1WDdHayUy7e3QkVTlAfB0Wk/exec">

        <div id="status-msg" class="hidden mb-4 p-4 rounded-lg text-center font-medium shadow-sm"></div>

        <h2 class="text-lg font-bold text-gray-700 mb-4 px-1">Pending Payment Requests</h2>
        
        <div id="pending-container" class="space-y-4">
            <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                <div class="loader mx-auto mb-3" style="width: 30px; height: 30px; border-width: 4px;"></div>
                <p class="text-gray-500 font-medium">Connecting to database...</p>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>

        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg scale-95 opacity-0 duration-300" id="modal-panel">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                <span class="material-icons text-blue-600">verified_user</span>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                <h3 class="text-lg font-bold leading-6 text-gray-900" id="modal-title">Confirm Approval</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500">
                                        Are you sure? This will accept payment and add <span class="font-bold text-blue-600 bg-blue-50 px-1 rounded">30 DAYS</span> validity to this user's license.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                        <button type="button" onclick="executeApproval()" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-colors">
                            Yes, Approve
                        </button>
                        <button type="button" onclick="closeModal()" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store current transaction details
        let pendingSheetId = null;
        let pendingBtn = null;

        // Auto-load
        window.onload = function() {
            fetchPending();
        };

        async function fetchPending() {
            const url = document.getElementById('script-url').value;
            const container = document.getElementById('pending-container');
            
            container.innerHTML = `
                <div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                    <div class="loader mx-auto mb-3" style="width: 30px; height: 30px; border-width: 4px;"></div>
                    <p class="text-gray-500 font-medium">Checking for payments...</p>
                </div>`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'adminGetPending' })
                });
                const res = await response.json();

                if (res.success) {
                    if (res.pending.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-100">
                                <span class="material-icons text-green-500 text-5xl mb-2">check_circle_outline</span>
                                <h3 class="text-lg font-bold text-gray-800">No Pending Requests</h3>
                                <p class="text-gray-400">All payments are up to date.</p>
                            </div>`;
                        return;
                    }
                    
                    // Render List
                    container.innerHTML = res.pending.map(item => `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:-translate-y-1 hover:shadow-md transition duration-200">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-xl font-bold text-gray-900">${item.username}</h3>
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full font-bold border border-yellow-200">PENDING</span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p class="flex items-center gap-2">
                                            <span class="material-icons text-sm text-gray-400">receipt</span>
                                            TrxID: <span class="font-mono bg-gray-50 px-1.5 py-0.5 rounded border border-gray-200 text-blue-600 font-bold">${item.trxId}</span>
                                        </p>
                                        <p class="flex items-center gap-2">
                                            <span class="material-icons text-sm text-gray-400">payments</span>
                                            Amount: <span class="font-bold text-green-600">${item.amount} Tk</span>
                                        </p>
                                    </div>
                                </div>
                                <button onclick="openModal('${item.sheetId}', this)" 
                                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow transition flex items-center justify-center gap-2">
                                    <span class="material-icons">verified</span> Payment Received
                                </button>
                            </div>
                            <div class="mt-4 pt-3 border-t border-gray-100 text-xs text-gray-400 font-mono">
                                Sheet ID: ${item.sheetId}
                            </div>
                        </div>
                    `).join('');
                } else {
                    showStatus(res.message, 'error');
                }
            } catch (e) {
                container.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-6 rounded-xl border border-red-200 text-center">
                        <span class="material-icons text-4xl mb-2">error_outline</span>
                        <p class="font-bold">Network Error</p>
                        <p class="text-sm opacity-80 mt-1">দয়া করে Apps Script URL ঠিক আছে কি না চেক করুন।</p>
                    </div>`;
            }
        }

        // --- Modal Logic ---
        function openModal(sheetId, btn) {
            pendingSheetId = sheetId;
            pendingBtn = btn;
            
            const modal = document.getElementById('confirm-modal');
            const panel = document.getElementById('modal-panel');
            
            modal.classList.remove('hidden');
            // Small timeout to allow transition
            setTimeout(() => {
                panel.classList.remove('scale-95', 'opacity-0');
                panel.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('confirm-modal');
            const panel = document.getElementById('modal-panel');
            
            panel.classList.remove('scale-100', 'opacity-100');
            panel.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                pendingSheetId = null;
                pendingBtn = null;
            }, 300);
        }

        // --- Execute Logic ---
        async function executeApproval() {
            // Close modal first
            const sheetId = pendingSheetId;
            const btn = pendingBtn;
            closeModal();

            if(!btn) return;

            const url = document.getElementById('script-url').value;
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = `<div class="loader border-white border-t-transparent"></div> Processing...`;
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'adminApprove', payload: { sheetId: sheetId } })
                });
                const res = await response.json();

                if(res.success) {
                    btn.innerHTML = `<span class="material-icons">check_circle</span> Approved`;
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                    
                    showStatus('Success! License extended for 30 days.', 'success');
                    
                    setTimeout(() => fetchPending(), 1500);
                } else {
                    alert('Error: ' + res.message);
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            } catch(e) {
                alert('Connection failed.');
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-msg');
            el.className = `mb-4 p-4 rounded-lg text-center font-bold ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            el.innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
